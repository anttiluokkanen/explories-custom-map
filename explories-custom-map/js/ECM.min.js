/**
 * ECM.min.js
 * @copyright   2018 Fakiirimedia Oy
 * @author      Hape Haavikko <hape.haavikko@fakiirimedia.com>
 * @version     1.2.6
 */
var ECM=function(N){"use strict";function W(){navigator.geolocation?H?console.log("User location set already"):(N("#myLocationBtn").prop("disabled",!0),N("#myLocationBtn").addClass("ecm-btn-loading"),navigator.geolocation.getCurrentPosition(function(e){H={lat:e.coords.latitude,lng:e.coords.longitude},t=new google.maps.Marker({position:H,map:R,optimized:!1,icon:{path:"M-20,0a20,20 0 1,0 40,0a20,20 0 1,0 -40,0",fillColor:"#06c",fillOpacity:1,strokeWeight:2,strokeColor:"#ffffff",scale:.4},title:"Your location"}),R.getBounds().contains(H)||Ce(),N("#followUserCB").parent().show(),setTimeout(B,ee.userPosInterval),N("#myLocationBtn").removeClass("ecm-btn-loading"),N("#myLocationBtn").hide()},function(){N("#myLocationBtn").removeClass("ecm-btn-loading"),N("#myLocationBtn").prop("disabled",!1),console.error("Getting user location failed.")})):console.error("Unable to get user location because geolocation is not supported by browser.")}function J(o){var a=N("#"+o).parent();a.addClass("loading");var e=R.getBounds(),t=ee.externalMarkers[o].url,n=ee.initLocation.lat,r=ee.initLocation.lat;R.getCenter().lat()&&(n=R.getCenter().lat(),r=R.getCenter().lng()),t=(t=(t=(t=(t=(t=t.replace("{lat}",n)).replace("{lng}",r)).replace("{north}",e.getNorthEast().lat())).replace("{east}",e.getNorthEast().lng())).replace("{south}",e.getSouthWest().lat())).replace("{west}",e.getSouthWest().lng()),y[o]&&y[o].abort(),y[o]=N.getJSON(t),y[o].done(function(e){a.removeClass("loading");var t=ee.externalMarkers[o].callbackName;window.ECM[t].call(this,e,o)}),y[o].fail(function(e,t,a){"abort"!=a&&console.error("Loading "+o+" failed: "+t+", "+a)})}function f(e){Y[e]=[];for(var t=0;t<q[e].length;t++){var a=q[e][t],o=ee.externalMarkers[e].iconW,n=ee.externalMarkers[e].iconH,r={lat:a.latitude,lng:a.longitude},i=new google.maps.Size(o,n);void 0!==o&&void 0!==n&&null!=o&&null!=n||(i=null);var l=new google.maps.MarkerImage(a.icon,null,null,null,i),s=new google.maps.Marker({index:parseInt(t),external:!0,id:a.id,name:a.name,position:r,map:R,icon:l,optimized:!0});s.addListener("click",function(){g.setContent(Me(q[e][this.index])),g.open(R,this)}),Y[e].push(s)}ne(),0<N(".ecm-feed").length&&(se(!1),se(!0))}function V(e,t){if(t){N("#ecmFiltersLayers").addClass("loading");var a=new google.maps.KmlLayer({url:ee.mapLayers[e].url,map:R,preserveViewport:!0});google.maps.event.addListener(a,"status_changed",function(){setTimeout(function(){N("#ecmFiltersLayers").removeClass("loading")},500)}),I[e]=a}else I[e].setMap(null)}function D(e,t){var d=ee.mapLayers[e],p=new google.maps.LatLngBounds(new google.maps.LatLng(d.bounds[1],d.bounds[0]),new google.maps.LatLng(d.bounds[3],d.bounds[2]));if(t){N("#ecmFiltersLayers").addClass("loading"),N("#ecmFiltersLayers .ecm-checkbox").each(function(){N(this).val()!=e&&N(this).prop("checked",!1)}),R.overlayMapTypes.setAt(0,null),ee.mapMinZoom<d.minZoom&&(N("#zoom").attr("min",d.minZoom),R.setOptions({minZoom:d.minZoom})),ee.mapMaxZoom>d.maxZoom&&(N("#zoom").attr("max",d.maxZoom),R.setOptions({maxZoom:d.maxZoom}));var a=new google.maps.ImageMapType({name:d.name,minZoom:d.minZoom,maxZoom:d.maxZoom,tileSize:new google.maps.Size(256,256),isPng:!0,opacity:1,getTileUrl:function(e,t){var a=R.getProjection(),o=Math.pow(2,t),n=256/o,r=256/o,i=new google.maps.LatLngBounds(a.fromPointToLatLng(new google.maps.Point(e.x*n,(e.y+1)*r)),a.fromPointToLatLng(new google.maps.Point((e.x+1)*n,e.y*r))),l=0<=e.x?e.x:o+e.x,s=e.y;if(p.intersects(i)&&t>=d.minZoom&&t<=d.maxZoom){var c=d.url.replace("{zoom}",t);return c=(c=c.replace("{x}",l)).replace("{y}",s)}}});a.addListener("tilesloaded",function(){N("#ecmFiltersLayers").removeClass("loading")}),R.overlayMapTypes.insertAt(0,a)}else R.overlayMapTypes.setAt(0,null),N("#zoom").attr("min",ee.mapMinZoom),N("#zoom").attr("max",ee.mapMaxZoom),R.setOptions({minZoom:ee.mapMinZoom,maxZoom:ee.mapMaxZoom});_e&&localStorage.setItem(d.name,t)}function K(){N("#ecmFiltersTypes .ecm-checkbox").each(function(){var e=N(this).val();ae[e].show=N(this).is(":checked")}),ae.markers.show||C.clearMarkers(),N("#ecmFiltersBadges").prop("disabled",!ae.routes.show),N("#ecmFiltersBadges .ecm-checkbox").prop("disabled",!ae.routes.show);var e=!ae.markers.show&&!ae.routes.show;N("#ecmFiltersTags").prop("disabled",e),N("#ecmFiltersTags .ecm-checkbox").prop("disabled",e),_e&&localStorage.setItem("types",JSON.stringify(ae)),ue()}function h(a,o){var e=Q[a][o],t=new google.maps.Polyline({path:e.waypoints,geodesic:!0,strokeColor:"#ffffff",strokeOpacity:1,strokeWeight:8}),n=new google.maps.Polyline({path:e.waypoints,geodesic:!0,strokeColor:e.polylineOptions.strokeColor,strokeOpacity:e.polylineOptions.strokeOpacity,strokeWeight:e.polylineOptions.strokeWeight});t.setMap(R),S[a][o]=t,n.setMap(R),T[a][o]=n,Q[a][o].length=n.getLengthInMeters(),google.maps.event.addListener(n,"click",function(e){var t=Q[a][o];g.setContent(Me(t)),g.setPosition(e.latLng),g.open(R)})}var n,c,p,R,e,r,g,H,t,G,a=document.getElementById("ecmScript"),u=a.src.replace(/js\/(ECM.js|ECM.min.js).*$/,""),o=a.src.replace(/explories-custom-map\/js\/(ECM.js|ECM.min.js).*$/,""),i=document.getElementById("ecm"),l="default",s=u+"themes/"+l+"/",d=s+l+".css",m=s+"config.js",v=s+"images/map-cluster.svg",q={},Q={},y=[],k=[],b=[],w=[],Y={},C=null,M=[],x=[],L=[],T=[],S=[],I=[],$=[],X=[],O=null,Z={ecmMarkerClusterer:{id:"ecmMarkerClusterer",file:u+"vendor/markerclusterer-1.0.1/markerclusterer.min.js",elType:"script",loaded:!1}},ee={markersUrl:"markers.json",routesUrl:"routes.json",lan:"fi",initLocation:{lat:60.169872,lng:24.938099},cardDefaultImg:s+"images/default-img.jpg",externalMarkers:null,mapDefaultTravelMode:"WALKING",mapInitZoom:10,mapMinZoom:0,mapMaxZoom:21,mapLayers:null,mapTypeId:"terrain",mapTypes:["roadmap","satellite","hybrid","terrain"],mapRouteMarkersThreshold:12,modes:null,offsetTop:"auto",offsetTopSel:"header",showBadgeFilters:!0,showMapFeedToggle:!0,showModeButtons:!0,showPrint:!1,showTagFilters:!0,showTypeFilters:!0,usePlugin:!1,userPosInterval:5e3},te={en:{badgeFiltersLegend:"Badges",hybrid:"Hybrid",mapLayers:"Map layers",mapType:"Map type",mapZoom:"Map zoom",marker:"Marker",myLocation:"My location",myLocationShow:"Show my location",myLocationCenter:"Center my location on map",roadmap:"Roadmap",route:"Route",satellite:"Satellite",shareArticle:"Share article",tagFiltersLegend:"Category",toggleTags:"Toggle all",typeFiltersLegend:"Type",terrain:"Terrain"},fi:{badgeFiltersLegend:"Badges",hybrid:"Hybridi",mapLayers:"Karttatasot",mapType:"Kartan tyyppi",mapZoom:"Kartan zoomaus",marker:"Kohde",myLocation:"Oma sijainti",myLocationShow:"Näytä sijaintini kartalla",myLocationCenter:"Keskitä kartta sijaintini mukaan",roadmap:"Tiekartta",route:"Reitti",satellite:"Satelliitti",shareArticle:"Jaa artikkeli",tagFiltersLegend:"Kategoria",toggleTags:"Valitse kaikki",typeFiltersLegend:"Tyyppi",terrain:"Maastokartta"}},ae={markers:{id:1,name:"marker",show:!0},routes:{id:2,name:"route",show:!0}},P=function(){if(0!=Object.keys(Z).length)for(var e in Z)if(Z.hasOwnProperty(e)){var t,a=Z[e];if(0<N("#"+e).length)continue;"script"==a.elType?((t=document.createElement("script")).id=e,t.src=a.file,document.body.appendChild(t)):"link"==a.elType&&((t=document.createElement("link")).id=e,t.href=a.file,t.rel="stylesheet",document.body.appendChild(t)),t.onload=function(){F(this.id)}}},F=function(e){for(var t in Z[e].loaded=!0,"ecmThemeConfig"==e&&1==ee.usePlugin&&(Z.ecmPluginConfig={id:"ecmPluginConfig",file:o+"assets/js/front.js",elType:"script",loaded:!1},P()),Z)if(Z.hasOwnProperty(t)&&!Z[t].loaded)return!1;return n=ee.initMode,i.getAttribute("data-offset-top")?(i.style.top=i.getAttribute("data-offset-top"),ee.offsetTop=i.getAttribute("data-offset-top")):"auto"==ee.offsetTop&&null!=ee.offsetTopSel?(Be(),N(window).resize(function(){Be()})):null!=ee.offsetTop&&(document.getElementById("ecm").style.top=ee.offsetTop),_e&&(localStorage.getItem("lat")&&localStorage.getItem("lng")&&(ee.initLocation.lat=parseFloat(localStorage.getItem("lat")),ee.initLocation.lng=parseFloat(localStorage.getItem("lng"))),localStorage.getItem("mapInitZoom")&&(ee.mapInitZoom=parseInt(localStorage.getItem("mapInitZoom"))),localStorage.getItem("types")&&(ae=JSON.parse(localStorage.getItem("types")))),A(),!0},A=function(){e=document.getElementById("ecmMap"),r={center:ee.initLocation,zoom:ee.mapInitZoom,minZoom:ee.mapMinZoom,maxZoom:ee.mapMaxZoom,zoomControl:!1,mapTypeId:ee.mapTypeId,streetViewControl:!1,fullscreenControl:!1,mapTypeControl:!1,gestureHandling:"greedy",styles:ee.modes[ee.initMode].styles},R=new google.maps.Map(e,r),g=new google.maps.InfoWindow({maxWidth:320,content:""}),R.addListener("zoom_changed",function(){ge(),N("#zoom").val(R.getZoom()),N("#zoomVal").text(R.getZoom()),me(),_e&&localStorage.setItem("mapInitZoom",R.getZoom())}),R.addListener("idle",function(){for(var e in ee.externalMarkers)ee.externalMarkers.hasOwnProperty(e)&&ee.externalMarkers[e].reloadOnBoundsChange&&N("#"+e).prop("checked")&&N("#"+e).trigger("change");_e&&(localStorage.setItem("lat",R.getCenter().lat()),localStorage.setItem("lng",R.getCenter().lng()))}),R.addListener("click",function(e){g.close()}),google.maps.LatLng.prototype.kmTo=function(e){var t=Math,a=t.PI/180,o=this.lat()*a,n=e.lat()*a,r=o-n,i=this.lng()*a-e.lng()*a;return 6378.137*(2*t.asin(t.sqrt(t.pow(t.sin(r/2),2)+t.cos(o)*t.cos(n)*t.pow(t.sin(i/2),2))))},google.maps.Polyline.prototype.getLengthInMeters=function(e){for(var t=this.getPath(e),a=t.getLength(),o=0,n=0;n<a-1;n++)o+=t.getAt(n).kmTo(t.getAt(n+1));return 1e3*o},google.maps.event.addListenerOnce(R,"idle",function(){xe(),z(),j()})},B=function(){navigator.geolocation.getCurrentPosition(function(e){H={lat:e.coords.latitude,lng:e.coords.longitude},t.setPosition(H),G&&R.panTo(H),setTimeout(B,ee.userPosInterval)},function(){console.error("Updating user location failed.")})},z=function(){if(Fe(),null===ee.markersUrl)return c=[],void(Array.isArray(p)&&E());var e=N.getJSON(ee.markersUrl);e.done(function(e){c=e,_(),U(c),Array.isArray(p)&&E()}),e.fail(function(e,t,a){console.error("Loading markers failed: "+t+", "+a)})},j=function(){if(Fe(),null===ee.routesUrl)return p=[],void(Array.isArray(c)&&E());var e=N.getJSON(ee.routesUrl);e.done(function(e){for(var t in p=e)if(Ee(p[t]))if(p[t].travelMode){var a=we(p[t]);ce(t,a,p[t].polylineOptions)}else ve(t);else p.splice(t,1);U(p),Array.isArray(c)&&E()}),e.fail(function(e,t,a){console.error("Loading routes failed: "+t+", "+a)})},E=function(){pe(),Le(),Te(),Pe(),i.getAttribute("data-feed")?(N("#ecmSettingsBtn").trigger("click"),N("#feedCB").trigger("click")):768<N(window).width()&&N("#ecmSettingsBtn").trigger("click"),i.getAttribute("data-article")&&ie(i.getAttribute("data-article")),Ae()},U=function(t){for(var a=0;a<t.length;a++){if(t[a].tags&&null!=t[a].tags)for(var o=0;o<t[a].tags.length;o++){$.some(function(e){return e.id===t[a].tags[o].id})||$.push(t[a].tags[o])}if(t[a].badges&&null!=t[a].badges)for(var n=0;n<t[a].badges.length;n++){X.some(function(e){return e.id===t[a].tags[n].id})||X.push(t[a].badges[n])}}},oe=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t].setMap(null);return[]},_=function(){if(w=oe(w),ae.markers.show){for(var e in c)if(he(c[e])&&(null===O||fe(c[e]))){var t={lat:c[e].latitude,lng:c[e].longitude};je(c[e].icon)||(c[e].icon=u+c[e].icon);var a=new google.maps.MarkerImage(c[e].icon,null,null,null,new google.maps.Size(32,32)),o=new google.maps.Marker({index:parseInt(e),id:c[e].id,position:t,map:R,icon:a,optimized:!0});o.addListener("click",function(){g.setContent(Me(c[this.index])),g.open(R,this)}),w.push(o)}ne()}},ne=function(){null!==C&&C.clearMarkers();var e={gridSize:56,zoomOnClick:!1,styles:[{textColor:"white",url:v,width:32,height:32}]},t=Se();try{C=new MarkerClusterer(R,w.concat(t),e)}catch(e){throw new Error("MarkerClusterer is undefined. Probably caused by private browsing mode.")}google.maps.event.addListener(C,"clusterclick",function(e){re(e.getMarkers())})},re=function(e){var t=N('<div class="ecm-cards-container"></div>');t.click(function(){t.remove(),N("#ecmSettingsBtn").show()});for(var a=Oe({icon:"icon-close.svg",name:"close",onClick:function(){t.remove(),N("#ecmSettingsBtn").show()},size:32}),o=N('<div class="ecm-cards"></div>'),n=0;n<e.length;n++){var r=e[n].index,i=c[r];e[n].external&&(i=q[e[n].name][r]),o.append(Me(i))}o.find(".ecm-card").click(function(e){e.stopPropagation()}),t.append(a),t.append(o),N("#ecm").append(t),Pe(),N("#ecmSettingsBtn").hide()},ie=function(e){var d=N('        <div class="ecm-article-container">            <div class="ecm-article">                <div class="ecm-loader"></div>            </div>        </div>'),t=Oe({icon:"icon-close.svg",name:"close-article",size:48});t.css("top",N("#ecm").css("top")),d.prepend(t),d.click(le),N("#ecm").append(d),Pe();var a=N.getJSON("https://explori.es/api/news/"+e);a.done(function(e){var t=N('<div class="ecm-article-logo"></div>'),a=N('<div class="ecm-article-img"></div>'),o=N('<div class="ecm-article-img-caption"></div>'),n=N("<h1>"+e.title+"</h1>"),r=N('<div class="ecm-article-body">'+e.text+"</div>");Ee(e.publication.image)&&(t.css("background-image","url('"+e.publication.image+"')"),Ee(e.publication.themeColor)&&t.css("background-color",e.publication.themeColor),N(".ecm-article").append(t)),Ee(e.caption)&&(o.append("<p>"+e.caption+"</p>"),a.append(o)),void 0!==e.images&&Ee(e.images.large)?(a.css("background-image","url('"+e.images.large+"')"),N(".ecm-article").append(a)):Ee(e.image)&&(a.css("background-image","url('"+e.image+"')"),N(".ecm-article").append(a)),r.prepend(n);var i=N('<div class="ecm-article-info"></div>'),l="";Ee(e.authors)?l=e.authors:Ee(e.user.name)&&(l=e.user.name),i.append('<p class="ecm-article-author">'+l+"</p>"),i.append('<p class="ecm-article-datetime">'+Ue(e.published)+"</p>"),r.prepend(i),d.find(".ecm-article").append(r),N(".ecm-article").click(function(e){e.stopPropagation()});var s=N('            <ul class="ecm-share">                <li><a href="#" class="ecm-icon-facebook" target="_blank"><span class="sr-only">Share on Facebook</span></a></li>                <li><a href="#" class="ecm-icon-twitter" target="_blank"><span class="sr-only">Share on Twitter</span></a></li>                <li><a href="#" class="ecm-icon-linkedin" target="_blank"><span class="sr-only">Share on LinkedIn</span></a></li>            </ul>            '),c=encodeURIComponent(window.location.href);s.find(".ecm-icon-facebook").attr("href","https://www.facebook.com/sharer.php?u="+c),s.find(".ecm-icon-twitter").attr("href","https://twitter.com/share?url="+c),s.find(".ecm-icon-linkedin").attr("href","https://www.linkedin.com/cws/share?url="+c),d.find(".ecm-article").append('<h2 class="ecm-share-h">'+te[ee.lan].shareArticle+"</h2>"),d.find(".ecm-article").append(s),d.find(".ecm-loader").remove()}),a.fail(function(e,t,a){console.error("Loading Explories article failed: "+t+", "+a)})},le=function(){N(".ecm-article-container").remove()},se=function(e){if(e){var t=N('<div class="ecm-cards-container ecm-feed ecm-feed-condensed"></div>'),a=N('<div class="ecm-cards"></div>');if(ae.routes.show)for(var o in p)he(p[o])&&(null===O||fe(p[o]))&&Ee(p[o].url)&&a.append(Me(p[o]));for(var n=Se(),r=w.concat(n),i=0;i<r.length;i++){var l=r[i].index,s=c[l];r[i].external&&(s=q[r[i].name][l]),Ee(s.url)&&a.append(Me(s))}a.find(".ecm-card").click(function(e){e.stopPropagation()}),t.append(a),N("#ecm").append(t)}else N(".ecm-feed").remove()},ce=function(o,e,n){k[o]=new google.maps.DirectionsService,b[o]=new google.maps.DirectionsRenderer({routeIndex:Date.now(),suppressPolylines:!0,suppressMarkers:R.getZoom()<ee.mapRouteMarkersThreshold,suppressInfoWindows:!1,preserveViewport:!0,markerOptions:{icon:{path:"M-20,0a20,20 0 1,0 40,0a20,20 0 1,0 -40,0",fillColor:n.strokeColor,fillOpacity:1,strokeWeight:2,strokeColor:"#ffffff",scale:.4}}}),b[o].setMap(R),k[o].route(e,function(e,t){if("OK"===t){b[o].setDirections(e);var a=e.routes[0];p[o].length=ke(a),p[o].duration=be(a),M[o]=e,ye(o,e,n)}else console.error("Directions request failed due to "+t)})},de=function(e){if(T[e])for(var t=0;t<T[e].length;t++)T[e][t].setMap(null),S[e][t].setMap(null)},pe=function(){if(function(){for(var e=0;e<x.length;e++)if(Array.isArray(x[e])){for(var t=0;t<x[e].length;t++)x[e][t].setMap(null);b[e].setMap(null)}else x[e]&&x[e].setMap(null),L[e]&&L[e].setMap(null)}(),ae.routes.show){for(var e=0;e<p.length;e++)he(p[e])&&(null!==O&&!fe(p[e])||(p[e].travelMode?ye(e,M[e],p[e].polylineOptions):ve(e)));ge()}},ge=function(){for(var e in b)void 0!==x[e]&&null!==x[e][0].getMap()&&(b[e].setOptions({suppressMarkers:R.getZoom()<ee.mapRouteMarkersThreshold}),b[e].setMap(R))},me=function(){if(ee.mapLayers)for(var e=0;e<ee.mapLayers.length;e++){var t=ee.mapLayers[e];if(!t.minZoom||!t.maxZoom)return;var a=t.minZoom>R.getZoom()||t.maxZoom<R.getZoom();N("#ecmFiltersLayers input:eq("+e+")").prop("disabled",a)}},ue=function(){O={tags:[],badges:[]},N("#ecmFiltersTags .ecm-checkbox:not(.ecm-toggle-all)").each(function(){N(this).prop("checked")?O.tags.push(parseInt(N(this).val())):N("#toggleTagsCB").prop("checked",!1)}),N("#ecmFiltersBadges .ecm-checkbox").each(function(){N(this).prop("checked")&&O.badges.push(parseInt(N(this).val()))}),0==O.tags.length&&0==O.badges.length&&(O=null),_e&&localStorage.setItem("filters",JSON.stringify(O)),_(),pe(),0<N(".ecm-feed").length&&(se(!1),se(!0))},fe=function(e){var t=!1;if(e.tags){var a=N.map(e.tags,function(e){return e.id});t=ze(O.tags,a)}if(e.badges){var o=N.map(e.badges,function(e){return e.id});t=t&&ze(O.badges,o)}return t},he=function(e){return!e.modes||-1!=e.modes.indexOf(n)},ve=function(a){var e=p[a];if(Array.isArray(e.waypoints)){var t=new google.maps.Polyline({path:e.waypoints,geodesic:!0,strokeColor:"#ffffff",strokeOpacity:1,strokeWeight:8}),o=new google.maps.Polyline({path:e.waypoints,geodesic:!0,strokeColor:e.polylineOptions.strokeColor,strokeOpacity:e.polylineOptions.strokeOpacity,strokeWeight:e.polylineOptions.strokeWeight});t.setMap(R),L[a]=t,o.setMap(R),x[a]=o,p[a].length=o.getLengthInMeters(),google.maps.event.addListener(o,"click",function(e){var t=p[a];g.setContent(Me(t)),g.setPosition(e.latLng),g.open(R)})}},ye=function(a,e,t){for(var o=[],n=e.routes[0].legs,r=0;r<n.length;r++)for(var i=n[r].steps,l=0;l<i.length;l++){for(var s=i[l].path,c=new google.maps.Polyline(t),d=0;d<s.length;d++)c.getPath().push(s[d]);o.push(c),c.setMap(R),google.maps.event.addListener(c,"click",function(e){var t=p[a];g.setContent(Me(t)),g.setPosition(e.latLng),g.open(R)})}x[a]=o},ke=function(e){for(var t=0,a=0;a<e.legs.length;++a)t+=e.legs[a].distance.value;return t},be=function(e){for(var t=0,a=0;a<e.legs.length;++a)t+=e.legs[a].duration.value;return t},we=function(e){var t=e.waypoints[0],a=e.waypoints[e.waypoints.length-1],o=new google.maps.LatLng(t.lat,t.lng),n=new google.maps.LatLng(a.lat,a.lng),r=[];e.waypoints.shift(),e.waypoints.pop();for(var i=0;i<e.waypoints.length;i++)r.push({location:new google.maps.LatLng(e.waypoints[i].lat,e.waypoints[i].lng)});return void 0===e.travelMode&&(e.travelMode=ee.mapDefaultTravelMode),{origin:o,destination:n,waypoints:r,optimizeWaypoints:!0,travelMode:e.travelMode}},Ce=function(){R.setZoom(R.getZoom()-1),google.maps.event.addListenerOnce(R,"idle",function(){R.getBounds().contains(H)||Ce()})},Me=function(e){var t=N('<a class="ecm-card"></a>');if(e.external&&(t.addClass("ecm-card-external"),t.append('<div class="ecm-card-external-icon"></div>'),Ee(e.logo))){var a=N('<div class="ecm-card-logo" style="background-image:url(\''+e.logo+"');\"></div>");Ee(e.color)&&a.css("background-color",e.color),t.append(a)}if(e.url?(t.attr("href",e.url),e.target&&t.attr("target",e.target)):t.addClass("ecm-card-no-link"),e.image||Ee(ee.cardDefaultImg)){var o=N('<div class="ecm-card-img-container"></div>'),n=N('<div class="ecm-card-img"></div>');e.image?(je(e.image)||(e.image=u+e.image),n.css("background-image","url('"+e.image+"')")):(n.css("background-image","url('"+ee.cardDefaultImg+"')"),n.addClass("ecm-default-img")),o.append(n),t.append(o)}if(e.badges||e.length)var r=N('<div class="ecm-card-info"></div>');if(e.badges&&Array.isArray(e.badges))for(var i=0;i<e.badges.length;i++){var l=N('<span class="ecm-card-badge">'+e.badges[i].name+"</span>");l.addClass("ecm-card-badge-"+e.badges[i].id),r.append(l)}if(e.length){var s=N('<span class="ecm-card-length">'+(e.length/1e3).toFixed(2)+" km</span>");r.append(s)}if((e.badges||e.length)&&t.append(r),e.title){var c=N("<h1>"+e.title+"</h1>");t.append(c)}if(e.description){var d=N("<p>"+e.description+"</p>");t.append(d)}if(e.tags&&Array.isArray(e.tags)){for(var p=N('<div class="ecm-card-tags"></div>'),g=0;g<e.tags.length;g++){je(e.tags[g].icon)||(e.tags[g].icon=u+e.tags[g].icon);var m=N("<img />");m.attr("src",e.tags[g].icon),m.attr("alt",e.tags[g].name),p.append(m)}t.append(p)}return t[0].outerHTML},xe=function(){if(ee.showModeButtons&&void 0!==ee.modes&&null!==ee.modes){var e=N('<div class="ecm-mode-buttons"></div>');for(var t in ee.modes)if(ee.modes.hasOwnProperty(t)){var a=ee.modes[t],o=N('<button type="button" class="ecm-btn">'+te[ee.lan][t]+"</button>");o.attr("id","ecm"+t.charAt(0).toUpperCase()+t.slice(1)+"Btn"),o.attr("data-id",a.id),o.attr("data-mode",t),o.addClass("ecm-btn-"+t),t==ee.initMode&&o.addClass("ecm-btn-active"),o.click(function(){var e;N(".ecm-mode-buttons .ecm-btn").removeClass("ecm-btn-active"),N(this).addClass("ecm-btn-active"),e=N(this).attr("data-mode"),void 0!==ee.modes[e]?(n=e,r=ee.modes[e].styles,R.setOptions({styles:r}),_(),pe()):console.error("Invalid mode")}),e.append(o)}N("#ecm").append(e)}},Le=function(){var e=N('<div class="ecm-map-controls"></div>');if(ee.showPrint){var t=Oe({icon:"icon-print.svg",name:"print",onClick:function(){window.print()},size:32});e.append(t)}var a=Oe({icon:"icon-location.svg",name:"location",onClick:function(){W()},size:32}),o=Oe({icon:"icon-plus.svg",name:"zoom-in",onClick:function(){R.setZoom(R.getZoom()+1)},size:32}),n=Oe({icon:"icon-minus.svg",name:"zoom-out",onClick:function(){R.setZoom(R.getZoom()-1)},size:32});e.append(a),e.append(o),e.append(n),N("#ecm").append(e)},Te=function(){var e=Oe({icon:["icon-settings.svg","icon-close.svg"],id:"ecmSettingsBtn",name:"settings",onClick:function(){N("#ecmSettings").toggleClass("ecm-panel-open"),N(".ecm-feed").toggleClass("ecm-feed-condensed"),N(this).find("svg").toggle()},size:32});N("#ecm").append(e);var t=N('<div id="ecmSettings" class="ecm-panel ecm-panel-settings"></div>');if(ee.showMapFeedToggle){var a=Ze({id:"feedCB",class:"ecm-switch",groupClass:"ecm-switch-group",label:"Feed",labelPre:"Map",onChange:function(){se(N(this).prop("checked"))}});t.append(a)}if(ee.showTypeFilters){var o=N('<fieldset id="ecmFiltersTypes" class="ecm-filters"></fieldset>');for(var n in o.append("<legend>"+te[ee.lan].typeFiltersLegend+"</legend>"),ae)if(ae.hasOwnProperty(n)){var r=ae[n],i=!0;if(_e&&Ee(localStorage.getItem("types")))0==JSON.parse(localStorage.getItem("types"))[n].show&&(i=!1);var l=Ze({id:"typeCB_"+r.id,checked:i,label:te[ee.lan][r.name],onChange:function(){K()},value:n});o.append(l)}t.append(o)}if(ee.showTagFilters){var s=N('<fieldset id="ecmFiltersTags" class="ecm-filters"></fieldset>');s.append("<legend>"+te[ee.lan].tagFiltersLegend+"</legend>");var c=Ze({id:"toggleTagsCB",class:"ecm-toggle-all",groupClass:"ecm-toggle-tags-group",checked:!0,label:te[ee.lan].toggleTags,onChange:function(){N("#ecmFiltersTags .ecm-checkbox").prop("checked",N(this).prop("checked")),ue()}});s.append(c);for(var d=0;d<$.length;d++){var p=$[d],g=!0;if(_e&&Ee(localStorage.getItem("filters")))-1==JSON.parse(localStorage.getItem("filters")).tags.indexOf(p.id)&&(g=!1);var m=Ze({id:"tagCB_"+p.id,checked:g,label:$[d].name,onChange:ue,value:p.id});s.append(m)}t.append(s)}if(Array.isArray(ee.externalMarkersSets)&&0<ee.externalMarkersSets.length)for(var u=0;u<ee.externalMarkersSets.length;u++){var f=ee.externalMarkersSets[u],h="ecmFiltersExternalMarkers"+f.id[0].toUpperCase()+f.id.substring(1),v=N('<fieldset id="'+h+'" class="ecm-filters"></fieldset>');if(v.append("<legend>"+te[ee.lan][f.id]+"</legend>"),f.showToggleAll){var y=Ze({id:"toggleExternal"+f.id+"CB",class:"ecm-toggle-all",groupClass:"ecm-toggle-tags-group",checked:!0,label:te[ee.lan].toggleTags,onChange:function(){var e=N(this).parent().parent();N(e).find(".ecm-checkbox:not(.ecm-toggle-all)").prop("checked",N(this).prop("checked")),N(e).find(".ecm-checkbox:not(.ecm-toggle-all)").trigger("change")}});v.append(y)}for(var k in ee.externalMarkers)if(ee.externalMarkers.hasOwnProperty(k)&&ee.externalMarkers[k].set==f.id){var b=ee.externalMarkers[k].checked;_e&&Ee(localStorage.getItem(k))&&(b=JSON.parse(localStorage.getItem(k)));var w=Ze({id:k,label:te[ee.lan][k],checked:b,onChange:function(){var e,t=N(this).parent().parent();N(this).prop("checked")?(J(N(this).attr("id")),N(t).find(".ecm-checkbox:not(.ecm-toggle-all):checked").length==N(t).find(".ecm-checkbox:not(.ecm-toggle-all)").length&&N(t).find(".ecm-toggle-all").prop("checked",!0)):(e=N(this).attr("id"),delete q[e],Y[e]=oe(Y[e]),delete Y[e],ne(),delete Q[e],de(e),0<N(".ecm-feed").length&&(se(!1),se(!0)),N(t).find(".ecm-toggle-all").prop("checked",!1)),_e&&localStorage.setItem(N(this).attr("id"),N(this).prop("checked"))},value:k});f.showToggleAll&&!ee.externalMarkers[k].checked&&v.find(".ecm-toggle-all").prop("checked",!1),v.append(w)}t.append(v)}if(ee.showBadgeFilters&&0<X.length){var C=N('<fieldset id="ecmFiltersBadges" class="ecm-filters"></fieldset>');C.append("<legend>"+te[ee.lan].badgeFiltersLegend+"</legend>");for(u=0;u<X.length;u++){var M=X[u],x=!0;if(_e&&Ee(localStorage.getItem("filters")))-1==JSON.parse(localStorage.getItem("filters")).badges.indexOf(M.id)&&(x=!1);var L=Ze({id:"badgeCB_"+M.id,checked:x,label:X[u].name,onChange:ue,value:M.id});C.append(L)}t.append(C)}if(Ee(ee.mapLayers)){var T=N('<fieldset id="ecmFiltersLayers" class="ecm-filters"></fieldset>');for(var S in T.append("<legend>"+te[ee.lan].mapLayers+"</legend>"),ee.mapLayers)if(ee.mapLayers.hasOwnProperty(S)){var I=ee.mapLayers[S].checked;_e&&Ee(localStorage.getItem(ee.mapLayers[S].name))&&(I=JSON.parse(localStorage.getItem(ee.mapLayers[S].name)));var O=Ze({id:ee.mapLayers[S].name,label:te[ee.lan][ee.mapLayers[S].name],data:[{name:"type",value:ee.mapLayers[S].type}],checked:I,onChange:function(){"kml"==N(this).attr("data-type")?V(N(this).val(),N(this).prop("checked")):"imageMapType"==N(this).attr("data-type")?D(N(this).val(),N(this).prop("checked")):console.error("Ivalid map layer type")},value:S});T.append(O)}t.append(T)}var Z=N('<div class="ecm-form-group"></div>');Z.append('<label for="mapType">'+te[ee.lan].mapType+"</label><br />");for(var P=N('<select id="mapType"></select>'),F=0;F<ee.mapTypes.length;F++){var A=ee.mapTypes[F],B=N("<option></option>");B.attr("value",A),B.text(te[ee.lan][A]),ee.mapTypeId==A&&B.prop("selected",!0),P.append(B)}Z.append(P),P.change(function(){R.setOptions({mapTypeId:N(this).val()}),_e&&localStorage.setItem("mapTypeId",N(this).val())}),t.append(Z);var z=N('<div class="ecm-form-group"></div>');z.append('<label for="zoom">'+te[ee.lan].mapZoom+"</label><br />"),z.append('<div class="ecm-range-labels"><span class="pull-left">-</span><span id="zoomVal">'+R.getZoom()+'</span><span class="pull-right">+</span></div>');var j=N('<input id="zoom" type="range" step="1" />');j.attr("min",ee.mapMinZoom),j.attr("max",ee.mapMaxZoom),z.append(j),j.val(R.getZoom()),j.on("input",function(){R.setZoom(parseInt(N(this).val())),N("#zoomVal").text(N(this).val())}),t.append(z);var E=N('<fieldset id="ecmMyLocation"></fieldset>');E.append("<legend>"+te[ee.lan].myLocation+"</legend>");var U=Oe({id:"myLocationBtn",icon:"icon-location.svg",name:"location",class:"ecm-btn-icon-text ecm-btn-block",text:te[ee.lan].myLocationShow,onClick:function(){W()}}),_=Ze({id:"followUserCB",label:te[ee.lan].myLocationCenter,onChange:function(){(G=N(this).prop("checked"))&&R.panTo(H)}});for(var k in _.hide(),E.append(U),E.append(_),t.append(E),N("#ecm").append(t),ue(),ee.externalMarkers)ee.externalMarkers.hasOwnProperty(k)&&N("#"+k).prop("checked")&&J(k);N("#ecmFiltersLayers .ecm-checkbox:checked").trigger("change")},Se=function(){var e=[];for(var t in Y)if(Y.hasOwnProperty(t))for(var a=0;a<Y[t].length;a++)e.push(Y[t][a]);return e},Ie=function(e){var t=[];if(Array.isArray(e))for(var a=0;a<e.length;a++)t.push({lat:e[a][1],lng:e[a][0]});return t},Oe=function(e){var t={class:null,disabled:!1,icon:null,id:null,name:null,onClick:null,size:null,text:null,tooltip:null};N.extend(t,e);var a,o=N('<button type="button" class="ecm-btn"></button>');if(t.disabled&&o.prop("disabled",!0),t.id&&o.attr("id",t.id),t.size&&o.addClass("ecm-btn-"+t.size),t.name&&o.addClass("ecm-btn-"+t.name),t.class&&o.addClass(t.class),t.icon)if(Array.isArray(t.icon))for(var n=0;n<t.icon.length;n++)a=N('<svg data-src="'+u+"images/"+t.icon[n]+'"></svg>'),o.append(a);else a=N('<svg data-src="'+u+"images/"+t.icon+'"></svg>'),o.append(a);return t.text&&o.append(t.text),t.onClick&&o.click(t.onClick),o},Ze=function(e){var t={checked:!1,class:null,data:null,groupClass:null,id:null,label:null,labelPre:null,name:null,onChange:null,tooltip:null,value:null};N.extend(t,e);var a=N('<div class="ecm-form-group-cb"></div>');if(t.labelPre){var o=N("<label></label>");o.text(t.labelPre),a.append(o)}var n=N('<input type="checkbox" class="ecm-checkbox" />');if(n.attr("id",t.id),n.attr("value",t.value),t.name&&n.attr("name",t.name),t.class&&n.addClass(t.class),t.groupClass&&a.addClass(t.groupClass),t.data)for(var r=0;r<t.data.length;r++)n.attr("data-"+t.data[r].name,t.data[r].value);if(t.checked&&n.prop("checked",!0),t.onChange&&n.change(t.onChange),a.append(n),t.label){var i=N("<label></label>");i.text(t.label),i.attr("for",t.id),a.append(i)}return a},Pe=function(){var e=document.querySelectorAll("svg[data-src]");SVGInjector(e,{evalScripts:!1,each:function(e){}},function(e){})},Fe=function(){N("#ecm").prepend('<div class="ecm-loader"></div>')},Ae=function(){N("#ecm > .ecm-loader").remove()},Be=function(){0<N(ee.offsetTopSel).length&&(document.getElementById("ecm").style.top=N(ee.offsetTopSel).outerHeight()+"px")},ze=function(t,e){return e.some(function(e){return 0<=t.indexOf(e)})},je=function(e){return/^((http|https):\/\/)|\/\//.test(e)},Ee=function(e){return"undefined"!==e&&null!==e&&""!=e},Ue=function(e){if(null==e||null==e||""==e)return"";var t=new Date(e.replace(/-/g,"/"));return t.getDate()+"."+(t.getMonth()+1)+"."+t.getFullYear()+" "+(("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2))},_e=function(){var e="test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}};return{init:function(){var e=document.createElement("div");if(e.id="ecmMap",document.getElementById("ecm").appendChild(e),"undefined"==typeof jQuery)throw new Error("ECM requires jQuery");if("undefined"==typeof SVGInjector&&(Z.ecmSVGi={id:"ecmSVGi",file:u+"vendor/svg-injector-1.1.3/dist/svg-injector.min.js",elType:"script",loaded:!1}),i.getAttribute("data-lan")&&(ee.lan=i.getAttribute("data-lan")),i.getAttribute("data-theme"))l=i.getAttribute("data-theme"),d=(s=u+"themes/"+l+"/")+l+".css",m=s+"config.js",v=s+"images/map-cluster.svg";else if(i.getAttribute("data-theme-key")){var t=i.getAttribute("data-theme-key");d=(s="https://ecm.explories.net/themes/")+"?key="+t+"&type=css",m=s+"?key="+t+"&type=config",v=s+"?key="+t+"&type=mapCluster"}Z.ecmThemeCss={id:"ecmThemeCss",file:d,elType:"link",loaded:!1},Z.ecmThemeConfig={id:"ecmThemeConfig",file:m,elType:"script",loaded:!1},P()},setConfig:function(e){for(var t in e)e.hasOwnProperty(t)&&(ee[t]=e[t]);ee.markersUrl&&(ee.markersUrl=ee.markersUrl.replace("{lan}",ee.lan)),ee.routesUrl&&(ee.routesUrl=ee.routesUrl.replace("{lan}",ee.lan))},setTexts:function(e){for(var t in e)if(e.hasOwnProperty(t))for(var a=Object.getOwnPropertyNames(e[t]),o=0;o<a.length;o++)te[t][a[o]]=e[t][a[o]]},convertLN2ECM:function(e,t){q[t]=[];for(var a=0;a<e.length;a++){e[a].images||(e[a].images={medium:e[a].thumbnail});var o="https://explori.es/fi/Article/"+e[a].id+"/"+e[a].slug,n="_blank",r=!0;ee.externalMarkers[t].articleViewUrl&&(o=(o=(o=ee.externalMarkers[t].articleViewUrl).replace("{id}",e[a].id)).replace("{slug}",e[a].slug),r=!(n="_self")),void 0!==ee.externalMarkers[t].external&&(r=ee.externalMarkers[t].external);var i={id:e[a].id,name:t,title:e[a].title,image:e[a].images.medium,logo:e[a].publication.image,color:e[a].publication.themeColor,latitude:parseFloat(e[a].latitude),longitude:parseFloat(e[a].longitude),url:o,target:n,icon:e[a].publication.marker,external:r};q[t].push(i)}f(t)},convertRetkipaikka2ECM:function(t,e){q[e]=[],Q[e]=[],de(e),T[e]=[],S[e]=[];for(var a=0;a<t.length;a++){var o=!1;for(var n in q)if(q.hasOwnProperty(n)&&-1!=n.search("retkipaikka")&&n!=e&&(o=q[n].some(function(e){return e.id===t[a].id})))break;if(!o){t[a].images||(t[a].images={medium:t[a].thumbnail});var r,i,l,s,c=!0,d="https://kartta.retkipaikka.fi/assets/marker.png",p={esteeton:0,helppo:1,keskivaativa:2,vaativa:3,luokittelematon:4},g={esteeton:"#3c3",helppo:"#03c",keskivaativa:"#c33",vaativa:"#000",luokittelematon:"#cc3"};if(t[a].marker&&(d="https://kartta.retkipaikka.fi/assets/"+t[a].marker),null!=t[a].link&&t[a].link.search("retkipaikka.fi")&&(c=!1),void 0!==ee.externalMarkers[e].external&&(c=ee.externalMarkers[e].external),t[a].images[0]&&(t[a].images[0]=t[a].images[0].replace("http://","https://")),"Point"==t[a].geometry.type)r=parseFloat(t[a].geometry.coordinates[1]),i=parseFloat(t[a].geometry.coordinates[0]);else if("LineString"==t[a].geometry.type)r=parseFloat(t[a].geometry.coordinates[0][1]),i=parseFloat(t[a].geometry.coordinates[0][0]),s=Ie(t[a].geometry.coordinates),l={id:t[a].id,title:t[a].title,image:t[a].images[0],polylineOptions:{strokeColor:"#0099ff",strokeOpacity:1,strokeWeight:5},waypoints:s},Ee(t[a].route_difficulty)&&(l.badges=[{id:p[t[a].route_difficulty],name:t[a].route_difficulty[0].toUpperCase()+t[a].route_difficulty.substring(1)}],l.polylineOptions.strokeColor=g[t[a].route_difficulty]),Q[e].push(l),h(e,Q[e].length-1);else if("MultiLineString"==t[a].geometry.type){r=parseFloat(t[a].geometry.coordinates[0][0][1]),i=parseFloat(t[a].geometry.coordinates[0][0][0]);for(var m=0;m<t[a].geometry.coordinates.length;m++)s=Ie(t[a].geometry.coordinates[m]),l={id:t[a].id,title:t[a].title,image:t[a].images[0],polylineOptions:{strokeColor:"#0099ff",strokeOpacity:1,strokeWeight:5},waypoints:s},Ee(t[a].route_difficulty)&&(l.badges=[{id:p[t[a].route_difficulty],name:t[a].route_difficulty[0].toUpperCase()+t[a].route_difficulty.substring(1)}],l.polylineOptions.strokeColor=g[t[a].route_difficulty]),Q[e].push(l),h(e,Q[e].length-1)}var u={id:t[a].id,name:e,title:t[a].title,image:t[a].images[0],logo:null,color:null,latitude:r,longitude:i,url:t[a].link,target:"_blank",icon:d,external:c};q[e].push(u)}}f(e)}}}(jQuery);
