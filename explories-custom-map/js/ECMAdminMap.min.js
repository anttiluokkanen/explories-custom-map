/**
 * ECMAdminMap.js
 * @copyright   2019 Fakiirimedia Oy
 * @author      Hape Haavikko <hape.haavikko@fakiirimedia.com>
 * @version     x.x.x
 */
var ECMAdminMap=function(i){"use strict";function o(){if(n=document.getElementById(m.mapElId),a={center:m.initLocation,zoom:m.mapInitZoom,mapTypeId:m.mapTypeId,streetViewControl:!1,fullscreenControl:!1,mapTypeControl:!1,gestureHandling:"greedy",disableDoubleClickZoom:!0},t=new google.maps.Map(n,a),i(window).keydown(function(e){if(13==e.keyCode)return e.preventDefault(),!1}),"marker"==m.mode)void 0!==ecmWP_AdminMap.ecm&&null!==ecmWP_AdminMap.ecm&&void 0!==ecmWP_AdminMap.ecm.lat&&void 0!==ecmWP_AdminMap.ecm.lng&&(p({lat:parseFloat(ecmWP_AdminMap.ecm.lat),lng:parseFloat(ecmWP_AdminMap.ecm.lng)}),void 0!==ecmWP_AdminMap.ecm.coordinates&&(i("#_ecm_coordinates").val(g()),i("#_ecm_map_placeholder code").text(g()))),google.maps.event.addListener(t,"click",function(e){p(e.latLng)}),google.maps.event.addListener(t,"dblclick",function(e){p(e.latLng)});else{if("route"!=m.mode)throw new Error('Invalid config.mode value. Valid values are "marker" or "route".');void 0!==ecmWP_AdminMap.ecm&&null!==ecmWP_AdminMap.ecm&&void 0!==ecmWP_AdminMap.ecm.mode&&void 0!==ecmWP_AdminMap.ecm.coordinates&&(ECMAdminMap.setConfig({mode:"route",route:{polylineOptions:{strokeColor:"#0099ff",strokeOpacity:1,strokeWeight:5},waypoints:ecmWP_AdminMap.ecm.coordinates}}),i("#_ecm_coordinates").val(JSON.stringify(ecmWP_AdminMap.ecm.coordinates,null,0)),i("#_ecm_map_placeholder code").text(JSON.stringify(ecmWP_AdminMap.ecm.coordinates,null,2))),null!=m.route&&s(m.route);var e=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYLINE,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,drawingModes:["polyline"]}});e.addListener("overlaycomplete",function(e){null!=d&&(console.log("should clear overlay"),d.setMap(null),d=null),d=e.overlay}),e.addListener("polylinecomplete",function(e){var o=e.getPath().getArray();for(var n in r=[],o){var t=o[n];r.push({lat:t.lat(),lng:t.lng()})}i("#_ecm_coordinates").val(JSON.stringify(r,null,0)),i("#_ecm_map_placeholder code").text(JSON.stringify(r,null,2))}),e.setMap(t)}u()}var t,n,a,l,r,c,m={initLocation:{lat:parseFloat(ecmWP_AdminMap.lat),lng:parseFloat(ecmWP_AdminMap.lng)},mapElId:"ecm-map",mapTypeId:"roadmap",mapInitZoom:parseInt(ecmWP_AdminMap.zoom),mode:ecmWP_AdminMap.mode,route:null},d=null,p=function(e){l?(l.setPosition(e),i("#_ecm_coordinates").val(g()),i("#_ecm_map_placeholder code").text(g())):l=new google.maps.Marker({position:e,map:t,draggable:!0}),google.maps.event.addListener(l,"drag",function(e){i("#_ecm_coordinates").val(g()),i("#_ecm_map_placeholder code").text(g())}),google.maps.event.addListener(l,"dragend",function(e){i("#_ecm_coordinates").val(g()),i("#_ecm_map_placeholder code").text(g())})},s=function(e){var o=new google.maps.Polyline({path:e.waypoints,geodesic:!0,strokeColor:"#ffffff",strokeOpacity:1,strokeWeight:8}),n=new google.maps.Polyline({path:e.waypoints,geodesic:!0,strokeColor:e.polylineOptions.strokeColor,strokeOpacity:e.polylineOptions.strokeOpacity,strokeWeight:e.polylineOptions.strokeWeight});o.setMap(t),n.setMap(t),0},g=function(){return l?l.getPosition().lat()+","+l.getPosition().lng():null},u=function(){if(document.getElementById("ecmPacInput")){(c=document.getElementById("ecmPacInput")).value="";var a,n,o=new google.maps.places.Autocomplete(c);n=(a=c).addEventListener?a.addEventListener:a.attachEvent,a.addEventListener?a.addEventListener=e:a.attachEvent&&(a.attachEvent=e),o.addListener("place_changed",function(){var e=o.getPlace();e.geometry?(t.setCenter(e.geometry.location),"marker"==m.mode&&p(e.geometry.location)):console.error("No details available for input: '"+e.name+"'")})}function e(e,o){if("keydown"==e){var t=o;o=function(e){var o=0<i(".pac-item-selected").length;if(13==e.which&&!o){var n=i.Event("keydown",{keyCode:40,which:40});t.apply(a,[n])}t.apply(a,[e])}}n.apply(a,[e,o])}};return{init:o,getMarkerLocation:g,getRouteWaypoints:function(){return r},setConfig:function(e){for(var o in e)e.hasOwnProperty(o)&&(m[o]=e[o])},setMode:function(e){m.mode=e,l&&(l.setMap(null),l=null),o()}}}(jQuery);
